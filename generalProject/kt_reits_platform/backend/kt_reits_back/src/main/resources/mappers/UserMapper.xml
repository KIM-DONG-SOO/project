<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace: DAO 인터페이스 경로와 일치해야 함 -->
<mapper namespace="com.example.dao.UserDAO">

    <!-- resultMap: DB 컬럼명과 DTO 필드명 매핑 -->
    <resultMap id="userResultMap" type="com.example.dto.UserDTO">
        <id property="userId" column="USER_ID" />
        <result property="userName" column="USER_NAME" />
        <result property="userEmail" column="USER_EMAIL" />
        <result property="userPw" column="USER_PW" />
        <result property="userRole" column="USER_ROLE" />
        <result property="phoneNumber" column="PHONE_NUMBER" />
        <result property="deptName" column="DEPT_NAME" />
        <result property="regDate" column="REG_DATE" />
        <result property="status" column="STATUS" />
    </resultMap>

    <!-- 이메일로 회원 조회 -->
    <select id="findByEmail" resultMap="userResultMap">
        SELECT * FROM USER_TB
        WHERE USER_EMAIL = #{userEmail}
        AND STATUS = 'ACTIVE'
    </select>

    <!-- 이메일 중복 체크 -->
    <select id="checkEmailExists" resultType="int">
        SELECT COUNT(*) FROM USER_TB
        WHERE USER_EMAIL = #{userEmail}
    </select>

    <!-- 회원가입 (시퀀스로 자동 ID 생성) -->
    <insert id="insertUser">
        INSERT INTO USER_TB (
            USER_ID, USER_NAME, USER_EMAIL, USER_PW, 
            USER_ROLE, PHONE_NUMBER, DEPT_NAME, STATUS
        ) VALUES (
            SEQ_USER.NEXTVAL, #{userName}, #{userEmail}, #{userPw},
            NVL(#{userRole}, 'STAFF'), #{phoneNumber}, #{deptName}, 'ACTIVE'
        )
    </insert>

    <!-- 회원 정보 수정 -->
    <update id="updateUser">
        UPDATE USER_TB
        SET USER_NAME = #{userName},
            PHONE_NUMBER = #{phoneNumber},
            DEPT_NAME = #{deptName}
            <!-- 비밀번호는 별도 API로 변경 -->
        WHERE USER_ID = #{userId}
    </update>

    <!-- 회원 비활성화 -->
    <update id="deactivateUser">
        UPDATE USER_TB
        SET STATUS = 'INACTIVE'
        WHERE USER_ID = #{userId}
    </update>

</mapper>